---
title: kubernetes-dnsä¼˜åŒ–ä¹‹è·¯
date: 2019-11-21
tags:
- kubernetes
- dns
- kube-dns
- coredns
- HostAliases
categories:
 - Container
---

## kube-dns

7æœˆä»½åˆšå¼€å§‹ç ”ç©¶çš„æ—¶å€™ï¼Œå› ä¸ºpodè¦è¯»å–é˜¿é‡Œäº‘RDSï¼Œå’Œä¸€äº›å…¬ç½‘çš„æ¥å£ï¼Œéœ€è¦DNSè§£æ

æ‰€ä»¥å®‰è£…äº†[kube-dns][1]ï¼Œè§£å†³äº†å®¹å™¨ä½¿ç”¨DNSè§£æçš„é—®é¢˜

---------

## é€ è½®å­è§£æå†…ç½‘hosts

åæ¥è¿˜æœ‰ä¸€äº›å†…ç½‘çš„è‡ªå®šä¹‰hostsè§£æï¼Œå› ä¸ºæ²¡æœ‰ä¸Šå…¬ç½‘ï¼Œæ‰€ä»¥éœ€è¦podè‡ªè¡ŒåŠ hostsè§£æ

åˆšå¼€æ˜¯ç ”ç©¶ä½¿ç”¨dockerfile+è„šæœ¬ï¼Œç»™å®¹å™¨å¼ºåŠ hostsï¼Œåæ¥å‘ç°è™½ç„¶å¯è¡Œï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå¹¶ä¸”è¿™ç§åšæ³•åœ¨ç›®å‰çœ‹æ¥æ˜¯ååˆ†è½åå’Œæ„šè ¢çš„

å› ä¸ºåé¢æœ‰æ›´å¥½çš„æ–¹æ¡ˆï¼Œè¿™é‡Œå°±ä¸æ”¾æ€ä¹ˆé€ è½®å­äº†ã€‚ã€‚ã€‚å…å¾—è¯¯å¯¼è§‚ä¼—

---------

## HostAliases

åæ¥å‘ç°ä»1.7ç‰ˆæœ¬å¼€å§‹ï¼Œk8sæ”¯æŒäº† HostAliases ç‰¹æ€§ï¼š `.spec.hostAliases`

```bash {14,15,16,17,18,19,20,21,22}
[root@k8s-master yaml]# cat paas-app/paas-gateway-server.yaml 
# ------------------- App Deployment ------------------- #
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: paas-gateway-server
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: paas-gateway-server
    spec:
      hostAliases:
      - ip: "10.255.0.170"
        hostnames:
        - "paas-nacos-register"
        - "paas-nacos-config"
      - ip: "10.1.2.3"
        hostnames:
        - "foo.remote"
        - "bar.remote"
      containers:
        - name: paas-gateway-server
          image: 'registry:5000/paas-gateway-server:latest'
          #imagePullPolicy: IfNotPresent
          imagePullPolicy: Always
     .................
```

ç™»é™†podæŸ¥çœ‹hosts

```bash  {12,13,14}
[root@k8s-master yaml]# kubectl exec -it paas-gateway-server-68f8d6f8fb-jkvn6 -- /bin/bash
root@paas-gateway-server-68f8d6f8fb-jkvn6:/app# cat /etc/hosts
# Kubernetes-managed hosts file.
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
fe00::0 ip6-mcastprefix
fe00::1 ip6-allnodes
fe00::2 ip6-allrouters
10.254.31.3     paas-gateway-server-68f8d6f8fb-jkvn6

# Entries added by HostAliases.
10.255.0.170    paas-nacos-register     paas-nacos-config
10.1.2.3        foo.remote      bar.remote
root@paas-gateway-server-68f8d6f8fb-jkvn6:/app# 
```

è¿™æ ·å­å°±å®Œç¾è§£å†³äº†

---------

## CoreDNS

åæ¥å› ä¸ºå®‰è£…[kubesphere][2]ï¼Œä½¿ç”¨devposçš„æ—¶å€™éœ€è¦æ·»åŠ registryè§£æï¼Œå‘ç°devopsç›¸å…³çš„yamléƒ½éœ€è¦åŠ ä¸€éhostAliases

**è¿™æ ·å­å¼Šç«¯å°±å‡ºç°äº†ï¼Œä¸šåŠ¡ä¸€æ—¦å¤šèµ·æ¥ï¼Œå°±å¾ˆéš¾ç»´æŠ¤**

**æ¥ç€åˆå‘ç°ä¸€ä¸ªæ›´å…ˆè¿›çš„dnsç³»ç»Ÿ-----CoreDNS**

ä» v1.11 å¼€å§‹å¯ä»¥ä½¿ç”¨ CoreDNS æ¥æä¾›å‘½åæœåŠ¡ï¼Œå¹¶ä» v1.13 å¼€å§‹æˆä¸ºé»˜è®¤ DNS æœåŠ¡ã€‚CoreDNS çš„ç‰¹ç‚¹æ˜¯æ•ˆç‡æ›´é«˜ï¼Œèµ„æºå ç”¨ç‡æ›´å°ï¼Œæ¨èä½¿ç”¨ CoreDNS æ›¿ä»£ kube-dns ä¸ºé›†ç¾¤æä¾› DNS æœåŠ¡ã€‚

ä» kube-dns å‡çº§ä¸º CoreDNS çš„æ­¥éª¤ä¸ºï¼š

```bash
$ git clone https://github.com/coredns/deployment
$ cd deployment/kubernetes
$ ./deploy.sh | kubectl apply -f -
$ kubectl delete --namespace=kube-system deployment kube-dns
```


å…¨æ–°éƒ¨ç½²CoreDNS

ä¿®æ”¹REVERSE_CIDRSã€DNS_DOMAINã€CLUSTER_DNS_IPç­‰å˜é‡ä¸ºå®é™…å€¼

å…·ä½“å‘½ä»¤

```bash
./deploy.sh -s -r 10.254.0.0/16 -i 10.254.0.100 -d cluster.local > coredns.yaml
diff coredns.yaml coredns.yaml.sed
kubectl create -f coredns.yaml
```

è¿™é‡Œä¸ç”¨æ‹…å¿ƒé•œåƒè¢«Qï¼Œéƒ½æ˜¯å¯ä»¥ä¸‹ä¸‹æ¥çš„ï¼Œä¸åƒkube-dnsçš„é•œåƒéƒ½æ˜¯googleä¸Šçš„~~

ä¸‹é¢å°±å±•ç¤ºä¸€ä¸‹ä½¿ç”¨CoreDNSæ·»åŠ è‡ªå®šä¹‰DNSè§£æè®°å½•

coredns è‡ªå¸¦ hosts æ’ä»¶ï¼Œ å…è®¸åƒé…ç½® hosts ä¸€æ ·é…ç½®è‡ªå®šä¹‰ DNS è§£æï¼Œä¿®æ”¹ kube-system ä¸­ configMap çš„ coredns æ·»åŠ å¦‚ä¸‹æ ‡é»‘è®¾ç½®å³å¯ã€‚

```bash {22,23,24,25,26,27,28}
[root@k8s-master system]# cat coredns/kubernetes/coredns.yaml
...
...
...
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health {
          lameduck 5s
        }
        ready
        kubernetes cluster.local  10.254.0.0/16 {
          pods insecure
          fallthrough in-addr.arpa ip6.arpa
        }
        hosts {
            10.255.0.170 registry
            10.127.0.16 paas-nacos-register
            10.127.0.16 paas-nacos-config

            fallthrough
        }
        prometheus :9153
        forward . /etc/resolv.conf
        cache 30
        loop
        reload
        loadbalance
    }
---
...
...
...
```

ä¹Ÿå¯ä»¥ä½¿ç”¨

`kubectl edit configmap coredns -n kube-system -o yaml`

è¯¥å‘½ä»¤å¯ç¼–è¾‘ coredns çš„é…ç½®æ–‡ä»¶ï¼Œç¼–è¾‘ data å­—æ®µå³å¯ï¼Œå³æ—¶ç”Ÿæ•ˆ

éªŒè¯

åˆ é™¤yamlé‡Œé¢çš„hostAliasesé…ç½®ï¼Œé‡æ–° kubectl apply

ç™»é™†å®¹å™¨pingä¸€ä¸‹

```bash
[root@k8s-master paas-app]# kubectl exec -it paas-gateway-server-8c6fb49ff-xd9tq -- /bin/bash
root@paas-gateway-server-8c6fb49ff-xd9tq:/app# cat /etc/hosts
# Kubernetes-managed hosts file.
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
fe00::0 ip6-mcastprefix
fe00::1 ip6-allnodes
fe00::2 ip6-allrouters
10.254.31.3     paas-gateway-server-8c6fb49ff-xd9tq

## hostsé…ç½®æ²¡æœ‰äº†ï¼Œç”±äºcorednsç›´æ¥åœ¨æœ€ä¸Šæ¸¸å®šä¹‰äº†hostsï¼Œæ‰€ä»¥è‡ªå®šä¹‰çš„è§£æç”Ÿæ•ˆäº†

root@paas-gateway-server-8c6fb49ff-xd9tq:/app# ping registry
PING registry (10.255.0.170): 56 data bytes
64 bytes from 10.255.0.170: icmp_seq=0 ttl=63 time=0.306 ms
64 bytes from 10.255.0.170: icmp_seq=1 ttl=63 time=0.278 ms
^C--- registry ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max/stddev = 0.278/0.292/0.306/0.000 ms
root@paas-gateway-server-8c6fb49ff-xd9tq:/app# 
```

å¯è§å³ä½¿æœ‰åœ¨å¤šçš„ä¸šåŠ¡ï¼Œåªè¦corednsåŠ äº†è§£æï¼Œéƒ½ä¸æ˜¯é—®é¢˜

**åœ¨æ­¤å¼ºåŠ›æ¨ècorednsæ–¹æ¡ˆï¼ˆæš‚æ—¶ï¼Œå¦‚æœè¿˜æœ‰æ›´å¥½çš„æ–¹æ¡ˆã€‚ã€‚ ğŸ˜‚ ğŸ˜‚ ğŸ˜‚ï¼‰**

----------

å½“ç„¶å¦‚æœå†…ç½‘æœ‰ä¸“é—¨çš„DNSæœåŠ¡å™¨ï¼›corednsæ”¯æŒé…ç½®ç§æœ‰ DNS æœåŠ¡å™¨å’Œä¸Šæ¸¸ DNS æœåŠ¡å™¨ï¼Œæ­¤å¤„å°±ä¸æ·±ç©¶äº†ï¼Œè¯¦è§å®˜æ–¹æ–‡æ¡£

https://kubernetes.io/zh/docs/tasks/administer-cluster/dns-custom-nameservers/

---------

å‚è€ƒ

https://ieevee.com/tech/2018/04/29/k8s-hostaliases.html

https://kubernetes.feisky.xyz/setup/addon-list/kube-dns#kube-dns

https://blog.csdn.net/kunyus/article/details/88841159

https://kubesphere.io/docs/v2.1/zh-CN/system-settings/edit-system-settings/#%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9-coredns-%E9%85%8D%E7%BD%AE


  [1]: https://linux48.com/container/2019-07-12-k8s.html#%E5%AE%89%E8%A3%85kube-dns
  [2]: https://kubesphere.com.cn/
